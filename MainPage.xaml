<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:PersonalFinanceTracker.ViewModels"
             xmlns:models="clr-namespace:PersonalFinanceTracker.Models"
             xmlns:behaviors="clr-namespace:PersonalFinanceTracker.Behaviors"
             xmlns:converters="clr-namespace:PersonalFinanceTracker.Converters"
             x:Class="PersonalFinanceTracker.MainPage"
             x:DataType="vm:MainViewModel"
             Title="Finance Tracker">
    <ContentPage.Resources>
        <ResourceDictionary>
            <vm:MainViewModel x:Key="MainViewModelProxy" x:FactoryMethod="GetInstance" />
            <converters:ProgressToColorConverter x:Key="ProgressToColorConverter" />
            <DataTemplate x:Key="BudgetTemplate" x:DataType="models:Budget">
                <Border Margin="5" Padding="10">
                    <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto">
                        <Label Grid.Column="0" Text="{Binding Category}" FontAttributes="Bold" FontSize="14" VerticalOptions="Center" />
                        <Label Grid.Column="1" Grid.Row="0" Text="{Binding Amount, StringFormat='\{0:C\}'}" FontSize="12" HorizontalOptions="End" VerticalOptions="Center" />
                        <ProgressBar Grid.ColumnSpan="2" Grid.Row="1"
                                     HeightRequest="20"
                                     MinimumHeightRequest="20"
                                     VerticalOptions="Center"
                                     ProgressColor="Gray" />
                    </Grid>
                </Border>
            </DataTemplate>
        </ResourceDictionary>
    </ContentPage.Resources>
    <Grid RowDefinitions="Auto,Auto,*,Auto,Auto,Auto"
          ColumnDefinitions="*,*"
          Padding="10"
          RowSpacing="10"
          ColumnSpacing="10">
        <Label Grid.Row="0" Grid.ColumnSpan="2"
               Text="Monthly Budgets"
               FontSize="20"
               FontAttributes="Bold" />
        <CollectionView Grid.Row="1" Grid.ColumnSpan="2"
                        ItemsSource="{Binding Budgets}"
                        ItemTemplate="{StaticResource BudgetTemplate}"
                        SelectionMode="None" />
        <Label Grid.Row="2" Grid.ColumnSpan="2"
               Text="Recent Transactions"
               FontSize="20"
               FontAttributes="Bold"
               Margin="0,10,0,0" />
        <CollectionView Grid.Row="3" Grid.ColumnSpan="2"
                        ItemsSource="{Binding Transactions}"
                        SelectionMode="None">
            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:Transaction">
                    <SwipeView>
                        <SwipeView.RightItems>
                            <SwipeItems>
                                <SwipeItem Text="Delete"
                                           BackgroundColor="Red"
                                           Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MainViewModel}}, Path=DeleteTransactionCommand}"
                                           CommandParameter="{Binding .}" />
                            </SwipeItems>
                        </SwipeView.RightItems>
                        <Grid Padding="0,5">
                            <Frame>
                                <Frame.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:MainViewModel}}, Path=ViewTransactionCommand}"
                                                          CommandParameter="{Binding .}" />
                                </Frame.GestureRecognizers>
                                <Grid ColumnDefinitions="*,Auto">
                                    <Label Text="{Binding Category}" FontAttributes="Bold" FontSize="14" />
                                    <Label Grid.Column="1"
                                           Text="{Binding Amount, StringFormat='{0:C}'}"
                                           TextColor="{Binding IsIncome, Converter={StaticResource IncomeToColorConverter}}"
                                           FontAttributes="Bold"
                                           FontSize="14" />
                                </Grid>
                            </Frame>
                        </Grid>
                    </SwipeView>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>
        <Button Grid.Row="4"
                Text="Add Transaction"
                Command="{Binding AddTransactionCommand}" />
        <Button Grid.Row="4" Grid.Column="1"
                Text="Add Budget"
                Command="{Binding AddBudgetCommand}" />
        <Button Grid.Row="5" Grid.ColumnSpan="2"
                Text="View Reports"
                Command="{Binding ViewReportsCommand}" />
    </Grid>
</ContentPage>